{$htmlheader|default:''}
    <h2>{$edit_title}</h2>
    <br />
    <form action="info.php?s={$smarty.session.p.series}" method="post" enctype="multipart/form-data">
      <input type="hidden" name="mode" value="confirm">
      <table id="ex_t" border="0" cellspacing="1" cellpadding="0">
{foreach from=$fields_info item=info}
        <tr>
 {if $info.kind != ''}
  {if $info.kind == 'title1'}
   {assign var="exist_edit_field" value=0}
          <td colspan="2"><h1>{$info.name}{if $info.placeholder != ''}&nbsp;<a {$info.select_info} >{$info.placeholder}</a>{/if}</h1></td>
   {if $mform_msg != ''}
          <td colspan="2">{$mform_msg}</td>
   {/if}
{*    <div class="f_box">*}
  {elseif $info.kind == 'title2'}
   {assign var="exist_edit_field" value=0}
          <td colspan="2"><h2>{$info.name}{if $info.placeholder != ''}&nbsp;<a {$info.select_info} >{$info.placeholder}</a>{/if}</h2></td>
  {elseif $info.kind == 'data_title'}
   {assign var="exist_edit_field" value=0}
          <td colspan="2"><h2>{$info.name}</h2></td>
  {elseif $info.kind == 'dantai_title1'}
   {assign var="exist_edit_field" value=0}
          <td colspan="2"><h2>{$info.name}</h2></td>
  {elseif $info.kind == 'dantai_title2'}
   {assign var="exist_edit_field" value=0}
          <td colspan="2"><h2>{$info.name}</h2></td>
  {elseif $info.kind == 'discription'}
   {assign var="exist_edit_field" value=0}
{*          <td colspan="2">{$info.placeholder}</td> *}
  {elseif $info.kind == 'f_box'}
   {assign var="exist_edit_field" value=0}
  {elseif $info.kind == 'f_box_end'}
   {assign var="exist_edit_field" value=0}
  {else}
   {assign var="exist_edit_field" value=1}
          <td class="td_left3">{$info.name}</td>
  {/if}

  {assign var="edit_field" value=$info.field}
  {if $exist_edit_field == 1}
          <td class="td_right">
  {/if}
  {if $info.kind == 'text'}
            <input type="text" name="{$edit_field}" value="{$smarty.session.p.$edit_field}" class="text" placeholder="{$info.placeholder}" >
  {elseif $info.kind == 'textarea'}
            <textarea name="{$edit_field}" cols="40" rows="3" maxlength="100" placeholder="{$info.placeholder}" >{$smarty.session.p.$edit_field}</textarea>
  {elseif $info.kind == 'check'}
            {html_checkboxes name=$edit_field options=$info.sel selected=$smarty.session.p.$edit_field separator='<br />'}
  {elseif $info.kind == 'check_one'}
            {html_checkboxes name=$edit_field options=$info.sel selected=$smarty.session.p.$edit_field separator='<br />'}
  {elseif $info.kind == 'select' || $info.kind == 'pref_select'}
            {html_options name=$edit_field options=$info.sel selected=$smarty.session.p.$edit_field}
  {elseif $info.kind == 'radio'}
            {html_radios name=$edit_field options=$info.sel selected=$smarty.session.p.$edit_field separator='<br />'}
  {elseif $info.kind == 'photo'}
   {assign var="edit_field_effect" value="`$edit_field`_effect"}
   {assign var="edit_field_rotate" value="`$edit_field`_rotate"}
   {if $smarty.session.p.$edit_field != ''}
            <div id="{$edit_field}_file_preview" style="width: 400px; height: 300px;">
              <img id="{$edit_field}_file_preview_image" src="../admin/upload/org/{$smarty.session.p.$edit_field}.jpg" width="400" />
            </div>
            画像回転：
            <input type="number" id="{$edit_field}_file_rotate_text" max="180" min="-180" value="{$smarty.session.p.$edit_field_rotate}">
            <input type="range" id="{$edit_field}_file_rotate" max="180" min="-180" step="1" value="{$smarty.session.p.$edit_field_rotate}"><br />
            画像ズーム：
            <input type="number" id="{$edit_field}_file_zoom_text" max="5" min="-5" step="0.05" value="0">
            <input type="range" id="{$edit_field}_file_zoom" max="5" min="-5" step="0.05" value="0">
   {else}
            <div>
              <img src="img/white.jpg" />
            </div>
   {/if}
            <br />
            <input id="{$edit_field}_file_op" name="{$edit_field}_file" type="file" value="" onchange_="updateImage('{$edit_field}');" />
            <input type="hidden" name="{$edit_field}" value="{$smarty.session.p.$edit_field}">
            <input type="hidden" name="{$edit_field}_effect" value="{$smarty.session.p.$edit_field_effect|escape:'html'}">
   {if $smarty.session.p.$edit_field != ''}
            <div style="margin-top: 8px;">
              <div style="float: left; padding: 8px;">
                カラー：<br />
                <img id="{$edit_field}_effect_image" src="../admin/upload/{$smarty.session.p.$edit_field}_01.jpg" width="300" style="filter: brightness(100%);" /><br />
                明るさ：
                <input type="number" id="{$edit_field}_file_brightness_text" max="200" min="1" value="{$smarty.session.p.$edit_field_rotate}">
                <input type="range" id="{$edit_field}_file_brightness" max="200" min="1" step="1" value="{$smarty.session.p.$edit_field_rotate}"><br />
              </div>
{*
              <div style="padding: 8px;">
                モノクロ：<br />
                <img src="../admin/upload/{$smarty.session.p.$edit_field}_01.jpg" width="300" /><br />
                明るさ：
                <input type="number" id="{$edit_field}_file_rotate_text" max="180" min="-180" value="{$smarty.session.p.$edit_field_rotate}">
                <input type="range" id="{$edit_field}_file_rotate" max="180" min="-180" step="1" value="{$smarty.session.p.$edit_field_rotate}"><br />
              </div>
*}
            </div>
   {/if}
          </div>
  {elseif $info.kind == 'name' || $info.kind == 'name_kana'}
   {assign var="edit_field_sei" value="`$edit_field`_sei"}
   {assign var="edit_field_mei" value="`$edit_field`_mei"}
            <input id="{$edit_field_sei}" type="text" name="{$edit_field_sei}" value="{$smarty.session.p.$edit_field_sei}" class="text" placeholder="姓" >
            <input id="{$edit_field_mei}" type="text" name="{$edit_field_mei}" value="{$smarty.session.p.$edit_field_mei}" class="text" placeholder="名" >
  {elseif $info.kind == 'name3'}
   {assign var="edit_field_sei" value="`$edit_field`_sei"}
   {assign var="edit_field_mei" value="`$edit_field`_mei"}
   {assign var="edit_field_add" value="`$edit_field`_add"}
            <input id="{$edit_field_sei}" type="text" name="{$edit_field_sei}" value="{$smarty.session.p.$edit_field_sei}" class="text" placeholder="姓" >
            <input id="{$edit_field_mei}" type="text" name="{$edit_field_mei}" value="{$smarty.session.p.$edit_field_mei}" class="text" placeholder="名" >
            <input id="{$edit_field_add}" type="text" name="{$edit_field_add}" value="{$smarty.session.p.$edit_field_add}" class="text" placeholder="備考：異体字など" >

  {elseif $info.kind == 'name4'}
   {assign var="edit_field_sei" value="`$edit_field`_sei"}
   {assign var="edit_field_mei" value="`$edit_field`_mei"}
   {assign var="edit_field_add" value="`$edit_field`_add"}
   {assign var="edit_field_disp" value="`$edit_field`_disp"}
            <input id="{$edit_field_sei}" type="text" name="{$edit_field_sei}" value="{$smarty.session.p.$edit_field_sei}" class="text" placeholder="姓" >
            <input id="{$edit_field_mei}" type="text" name="{$edit_field_mei}" value="{$smarty.session.p.$edit_field_mei}" class="text" placeholder="名" >
            <input id="{$edit_field_add}" type="text" name="{$edit_field_add}" value="{$smarty.session.p.$edit_field_add}" class="text" placeholder="備考：異体字など" >
            <input id="{$edit_field_disp}" type="text" name="{$edit_field_disp}" value="{$smarty.session.p.$edit_field_disp}" class="text" placeholder="表示名" >

  {elseif $info.kind == 'name5'}
   {assign var="edit_field_sei" value="`$edit_field`_sei"}
   {assign var="edit_field_mei" value="`$edit_field`_mei"}
   {assign var="edit_field_add" value="`$edit_field`_add"}
   {assign var="edit_field_disp" value="`$edit_field`_disp"}
            <input id="{$edit_field_sei}" type="text" name="{$edit_field_sei}" value="{$smarty.session.p.$edit_field_sei}" maxlength="4" class="text" placeholder="名字" >
            <input id="{$edit_field_mei}" type="text" name="{$edit_field_mei}" value="{$smarty.session.p.$edit_field_mei}" class="text" placeholder="名前" >
            <input id="{$edit_field_add}" type="checkbox" name="{$edit_field_add}" value="1" class="text" {if $smarty.session.p.$edit_field_add==1}checked="checked" {/if} style="width: 1em;">異体字あり

  {elseif $info.kind == 'name6'}
   {assign var="edit_field_sei" value="`$edit_field`_sei"}
   {assign var="edit_field_mei" value="`$edit_field`_mei"}
   {assign var="edit_field_add" value="`$edit_field`_add"}
   {assign var="edit_field_disp" value="`$edit_field`_disp"}
            <input id="{$edit_field_sei}" type="text" name="{$edit_field_sei}" value="{$smarty.session.p.$edit_field_sei}" maxlength="4" class="text" placeholder="名字" >
            <input id="{$edit_field_mei}" type="text" name="{$edit_field_mei}" value="{$smarty.session.p.$edit_field_mei}" class="text" placeholder="名前" >
            <input id="{$edit_field_add}" type="checkbox" name="{$edit_field_add}" value="1" class="text" {if $smarty.session.p.$edit_field_add==1}checked="checked" {/if} style="width: 1em;">異体字あり
            <input id="{$edit_field_disp}" type="text" name="{$edit_field_disp}" value="{$smarty.session.p.$edit_field_disp}" class="text" placeholder="表示名" >

  {elseif $info.kind == 'tel_fax'}
   {assign var="edit_field_tel" value="`$edit_field`_tel"}
   {assign var="edit_field_fax" value="`$edit_field`_fax"}
            <input id="{$edit_field_tel}" type="text" name="{$edit_field_tel}" value="{$smarty.session.p.$edit_field_tel}" class="text" placeholder="電話番号" >
            <input id="{$edit_field_fax}" type="text" name="{$edit_field_fax}" value="{$smarty.session.p.$edit_field_fax}" class="text" placeholder="FAX番号" >

  {elseif $info.kind == 'mobile_tel'}
   {assign var="edit_field_mobile" value="`$edit_field`_mobile"}
   {assign var="edit_field_tel" value="`$edit_field`_tel"}
            <input id="{$edit_field_mobile}" type="text" name="{$edit_field_mobile}" value="{$smarty.session.p.$edit_field_mobile}" class="text" placeholder="携帯番号" >
            <input id="{$edit_field_tel}" type="text" name="{$edit_field_tel}" value="{$smarty.session.p.$edit_field_tel}" class="text" placeholder="電話番号" >

  {elseif $info.kind == 'school_org'}
   {assign var="edit_field_school_name" value="`$edit_field`_school_name"}
            <input id="{$edit_field_school_name}" type="text" name="{$edit_field_school_name}" value="{$smarty.session.p.$edit_field_school_name}" class="text" placeholder="○○" >
            {html_options name=$edit_field options=$org_array selected=$smarty.session.p.$edit_field}

  {elseif $info.kind == 'school_name'}
   {assign var="edit_field_school_org" value="`$edit_field`_org"}
            <input id="{$edit_field_school_org}" type="text" name="{$edit_field_school_org}" value="{$smarty.session.p.$edit_field_school_org}" class="text" placeholder="○○" >立
            <input type="text" name="{$edit_field}" value="{$smarty.session.p.$edit_field}" class="text" placeholder="{$info.placeholder}" >

  {elseif $info.kind == 'school_name_kana'}
            <input type="text" name="{$edit_field}" value="{$smarty.session.p.$edit_field}" class="text" placeholder="{$info.placeholder}" >

  {elseif $info.kind == 'address'}
   {assign var="edit_field_zip1" value="`$edit_field`_zip1"}
   {assign var="edit_field_zip2" value="`$edit_field`_zip2"}
   {assign var="edit_field_pref" value="`$edit_field`_pref"}
            <input id="{$edit_field_zip1}" type="text" name="{$edit_field_zip1}" value="{$smarty.session.p.$edit_field_zip1}" class="text" placeholder="郵便番号" >
            -<input id="{$edit_field_zip2}" type="text" name="{$edit_field_zip2}" value="{$smarty.session.p.$edit_field_zip2}" class="text" placeholder="郵便番号">
            <input id="{$edit_field}_input" type="button" name="{$edit_field}_input" value="住所自動入力" class="" onClick="zip_search();"><br />
            {html_options name=$edit_field_pref options=$pref_array selected=$smarty.session.p.$edit_field_pref}
            <input style="width: 400px;" id="{$edit_field}" type="text" name="{$edit_field}" value="{$smarty.session.p.$edit_field}" class="text" placeholder="住所" >

  {elseif $info.kind == 'address_pref'}
            {html_options name=$edit_field options=$pref_array selected=$smarty.session.p.$edit_field}

  {elseif $info.kind == 'grade_j'}
            {html_options name=$edit_field options=$grade_junior_array selected=$smarty.session.p.$edit_field}

  {elseif $info.kind == 'grade_e'}
            {html_options name=$edit_field options=$grade_elementary_array selected=$smarty.session.p.$edit_field}

  {elseif $info.kind == 'email'}
            <input type="text" name="{$edit_field}" value="{$smarty.session.p.$edit_field}" class="text" placeholder="{$info.placeholder}" >

  {elseif $info.kind == 'gakunen_dan_j'}
   {assign var="edit_field_gakunen" value="`$edit_field`_gakunen"}
            <input name="{$edit_field_gakunen}" type="radio" value="1" {if $smarty.session.p.$edit_field_gakunen==1}checked="checked"{/if}>
            １年
            <input name="{$edit_field_gakunen}" type="radio" value="2" {if $smarty.session.p.$edit_field_gakunen==2}checked="checked"{/if}>
            ２年
            <input name="{$edit_field_gakunen}" type="radio" value="3" {if $smarty.session.p.$edit_field_gakunen==3}checked="checked"{/if}>
            ３年
   {assign var="edit_field_dan" value="`$edit_field`_dan"}
            <input type="text" name="{$edit_field_dan}" id="{$edit_field_dan}" value="{$smarty.session.p.$edit_field_dan|escape}" placeholder="段位">

  {elseif $info.kind == 'yosen_rank'}
            {html_options name=$edit_field options=$yosen_rank_array selected=$smarty.session.p.$edit_field}

  {elseif $info.kind == 'hidden'}
            <input type="hidden" name="{$edit_field}" value="{$smarty.session.p.$edit_field}" >

  {elseif $info.kind == 'literal'}
            {$info.placeholder}

  {elseif $info.kind == 'include'}
   {assign var="include_file" value="reg/mform_`$smarty.session.auth.series`_`$info.select_info`.html"}
            {include file="$include_file"}
  {/if}
 {/if}
          </td>
 {if $exist_edit_field == 1}
        </tr>
 {/if}
{/foreach}
      </table>
      <br />
      <input type="submit" name="cancel" value="中止">
{if $smarty.session.auth.locked == 0}
      <input type="submit" name="exec" value="実行">
{/if}
    </form>
    <br />
    <br />
    <br />
<script type="text/javascript">
{literal}
<!--
{/literal}
    let cropper = [ null, null ];
    let zoom = [ 0, 0 ];
    let brightness = [ 100, 100 ];
      
    // ファイルのアップロード
    function previewImage(field,imageUrl,width,field_index)
    {
        const img = $('#'+field+'_file_preview_image').eq(0);
        const img_effect = $("input[name='"+field+"_effect']").val();
        let data = null;
        if( img_effect != '' ){
            let jdata = JSON.parse(img_effect);
            data = jdata.crop;
            brightness[field_index] = jdata.brightness;
            $('#'+field+'_file_brightness').val(jdata.brightness);
            $('#'+field+'_file_brightness_text').val(jdata.brightness);
            $('#'+field+'_effect_image').css('filter', 'brightness(' + jdata.brightness + '%)');
        }
        if( imageUrl != null ){
            img.attr('src',imageUrl); // 画像のURLをimg要素にセット
        }
        if( cropper[field_index] != null ){
            cropper[field_index].destroy();
            cropper[field_index] = null;
        }
        cropper[field_index] = new Cropper(
            img.get(0),
            {
                viewMode: 0,
                checkOrientation: true,
                zoomOnwheel: false,
                zoomOntouch: false,            
                data: data,
                background: false,
                autoCropArea: 1,
                movable: true,
                rotatable: true,
                scalable: false,
                zoomable: true,
                crop(event) {
                    let d = JSON.stringify(event.detail);
                    const img_effect = '{ "crop":' + d + ',' + '"brightness": ' + brightness[field_index] + ' }';
                    $("input[name='"+field+"_effect']").val(img_effect);
                }
            }
        );
    }
      
    function previewFile(file,field,width,field_index)
    {
        const preview = $('#'+field+'_file_preview');
        const reader = new FileReader();
        reader.onload = function (e) {
            const imageUrl = e.target.result; // 画像のURLはevent.target.resultで呼び出せる
            $("input[name='"+field+"_effect']").val('');
            previewImage(field,imageUrl,width,field_index);
        }
        reader.readAsDataURL(file);
    }
      
    function updateImage( field, width, field_index )
    {
        const fileInput = document.getElementById(field+'_file_op');
        const files = fileInput.files;
        for (let i = 0; i < files.length; i++) {
            previewFile(files[i],field,width,field_index);
        }
        return;
     
        showActiveIndicator();
        // FormData の作成
        $("#form_entry [name='imageupload']").val(field);
        var form = $('#form_entry').get()[0];
        var formData = new FormData(form);
        // FormData を送信
        $.ajax({
            url: "uploadimage.php",
            method: 'POST',
            contentType: false,
            processData: false,
            data: formData,
            dataType: 'text',
            error: function(XMLHttpRequest, textStatus, errorThrown) {
                hideActiveIndicator();
                console.log('error');
            //	alert(XMLHttpRequest.status+":"+textStatus+":"+errorThrown.message);
            },
            success: function(data, dataType) {
                hideActiveIndicator();
                console.log('success');
                if( data != '' ){
                    $("#"+field+"_preview img:eq(0)").attr( 'src', 'upload/'+data+'_02.jpg' ).css("width","200px");
                    $("#"+field+"_file_del").css("display","inline");
                    $("#form_entry [name='"+field+"']").val(data);
                    $("#form_entry [name='"+field+"_file']").val('');
                }
                //	alert( data );
            }
        });
    }
      
    // ファイルのアップロード
    function deleteImage( field )
    {
        if( !window.confirm('画像を削除してよろしいでしょうか？') ){ return false; }
        $("#"+field+"_preview img:eq(0)").attr( 'src', 'img/white.jpg' ).css("width","16px");
        $("#"+field+"_file_del1").css("display","none");
        $("#form_entry [name='"+field+"']").val('');
        $("#form_entry [name='"+field+"_file']").val('');
    }

{assign var="photo_index" value=0}
{foreach from=$fields_info item=info name=fields}
 {assign var="edit_field" value=$info.field}
 {if $info.kind == 'photo'}
  {if $smarty.session.p.$edit_field != ''}
    previewImage('{$edit_field}',null,{$info.text_width},{$photo_index});
  {/if}

    $('#{$edit_field}_file_rotate').on('input', function () {
        let val = $(this).val();
        $('#{$edit_field}_file_rotate_text').val(val);
        let d = JSON.parse($("input[name='{$edit_field}_effect']").val());
        let prev_val = d.crop.rotate * -1;
        cropper[{$photo_index}].rotate(prev_val);
        cropper[{$photo_index}].rotate(val);
    });

    $('#{$edit_field}_file_rotate_text').on('input', function () {
        let val = $(this).val();
        $('#{$edit_field}_file_rotate').val(val);
        let d = JSON.parse($("input[name='{$edit_field}_effect']").val());
        let prev_val = d.crop.rotate * -1;
        cropper[{$photo_index}].rotate(prev_val);
        cropper[{$photo_index}].rotate(val);
    });

    $('#{$edit_field}_file_zoom').on('input', function () {
        let val = $(this).val();
        $('#{$edit_field}_file_zoom_text').val(val);
        let prev_val = zoom[{$photo_index}] * -1;
        cropper[{$photo_index}].zoom(prev_val);
        cropper[{$photo_index}].zoom(val);
        zoom[{$photo_index}] = val;
    });

    $('#{$edit_field}_file_zoom_text').on('input', function () {
        let val = $(this).val();
        $('#{$edit_field}_file_zoom').val(val);
        let prev_val = zoom[{$photo_index}] * -1;
        cropper[{$photo_index}].zoom(prev_val);
        cropper[{$photo_index}].zoom(val);
        zoom[{$photo_index}] = val;
    });

    $('#{$edit_field}_file_brightness').on('input', function () {
        let val = $(this).val();
        $('#{$edit_field}_file_brightness_text').val(val);
        brightness[{$photo_index}] = parseInt(val);
        let d = JSON.parse($("input[name='{$edit_field}_effect']").val());
        d.brightness = val;
        $("input[name='{$edit_field}_effect']").val(JSON.stringify(d));
        $("#{$edit_field}_effect_image").css('filter', 'brightness(' + val + '%)');
    });

    $('#{$edit_field}_file_brightness_text').on('input', function () {
        let val = $(this).val();
        $('#{$edit_field}_file_brightness').val(val);
        brightness[{$photo_index}] = parseInt(val);
        let d = JSON.parse($("input[name='{$edit_field}_effect']").val());
        d.brightness = val;
        $("input[name='{$edit_field}_effect']").val(JSON.stringify(d));
        $("#{$edit_field}_effect_image").css('filter', 'brightness(' + val + '%)');
    });

  {assign var="photo_index" value=1}
 {/if}
{/foreach}
{literal}
-->
{/literal}
</script>
{$htmlfooter|default:''}
